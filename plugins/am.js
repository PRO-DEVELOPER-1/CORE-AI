//(function(zhjO_EiMp,pxwUHcUwWpVbqnmfG$jJ$CF){const aHVYNgHiQfnpgRHE=DFLWhia_ER$XtmGLFUwR,vhFLivv$OrZHWsRUDMPQqXEy=zhjO_EiMp();while(!![]){try{const BbTYoWWlRfiQFnCAQhOOZaR=parseFloat(aHVYNgHiQfnpgRHE(0xa2))/(0x25de*parseInt(0x1)+parseFloat(0x23cc)+Math.max(-parseInt(0x49a9),-0x49a9))+-parseFloat(aHVYNgHiQfnpgRHE(0xb6))/(parseInt(0x201)+Math.max(parseInt(0xd),parseInt(0xd))*0x5c+-0x6ab)*(-parseFloat(aHVYNgHiQfnpgRHE(0xb0))/(parseInt(-parseInt(0x115))*parseInt(0x24)+-0x3fb+Math.trunc(0x2)*Math.floor(0x1579)))+parseFloat(parseFloat(aHVYNgHiQfnpgRHE(0x99))/(Math.floor(parseInt(0xc1))+-parseInt(0x3e)*0x93+parseInt(0x4b)*Math.ceil(0x77)))*(parseFloat(aHVYNgHiQfnpgRHE(0xaa))/(-parseInt(0x1cb5)*Math.trunc(parseInt(0x1))+-0x1993*-parseInt(0x1)+-0x327*-parseInt(0x1)))+-parseFloat(aHVYNgHiQfnpgRHE(0xad))/(parseInt(0x39e)*-parseInt(0x5)+Math.ceil(0x2257)+parseFloat(parseInt(0xf))*Math.ceil(-parseInt(0x115)))+Math['ceil'](parseFloat(aHVYNgHiQfnpgRHE(0xb7))/(Math.ceil(0x1046)+-parseInt(0x18)*-parseInt(0xd3)+-parseInt(0x2407)))+Number(-parseFloat(aHVYNgHiQfnpgRHE(0x9c))/(parseInt(0x119b)+parseInt(0x6ac)+0x183f*-parseInt(0x1)))+parseFloat(aHVYNgHiQfnpgRHE(0xb1))/(0x2047+Number(-0x1)*-parseInt(0x1eef)+-parseInt(0x257)*0x1b)*(-parseFloat(aHVYNgHiQfnpgRHE(0xa8))/(-0x2ed*-parseInt(0x2)+Math.floor(parseInt(0x2))*parseFloat(-parseInt(0xd6a))+parseInt(0x14)*parseInt(0x10d)));if(BbTYoWWlRfiQFnCAQhOOZaR===pxwUHcUwWpVbqnmfG$jJ$CF)break;else vhFLivv$OrZHWsRUDMPQqXEy['push'](vhFLivv$OrZHWsRUDMPQqXEy['shift']());}catch(GPWOHdowboE$FwUVFRVdFvIa_jo){vhFLivv$OrZHWsRUDMPQqXEy['push'](vhFLivv$OrZHWsRUDMPQqXEy['shift']());}}}(aFECsXhqoUUfYS,0x3*Math.max(-0x1086,-0x1086)+Math.trunc(parseInt(0x4))*parseInt(0x1b659)+Number(parseInt(0x14976))));import bmeGmZQOYV$NDpkXIimj from'@whiskeysockets/baileys';const {makeWASocket,useMultiFileAuthState,fetchLatestBaileysVersion,jidDecode}=bmeGmZQOYV$NDpkXIimj;function DFLWhia_ER$XtmGLFUwR(e$GmZQOYVND,kXIimjaauRh){const COLKNIqZL=aFECsXhqoUUfYS();return DFLWhia_ER$XtmGLFUwR=function(SOBHmzqDMdfthWVxdM,MrztLsf_SqEX){SOBHmzqDMdfthWVxdM=SOBHmzqDMdfthWVxdM-(parseInt(0x1355)+parseInt(-0x14ad)+Math.floor(parseInt(0x2))*Math.trunc(0xf8));let fE$rQs=COLKNIqZL[SOBHmzqDMdfthWVxdM];if(DFLWhia_ER$XtmGLFUwR['sBwvzx']===undefined){const Wfi_XQI_FHEwsVmHTdAatIBbw=function(VeQPqqdH$kwAlkcL$r){let aEmDQtGjZsKBOvkNXnPraGF_a=Math.trunc(parseInt(0xed5))*Number(-parseInt(0x1))+Number(-parseInt(0x10e7))+parseInt(0x1bf)*Math.floor(parseInt(0x13))&parseFloat(-0x1c40)+parseInt(0x527)*-parseInt(0x5)+Number(-parseInt(0x3))*-parseInt(0x1256),MIXcWzkDaEKqqo=new Uint8Array(VeQPqqdH$kwAlkcL$r['match'](/.{1,2}/g)['map'](VDtKrVQUH=>parseInt(VDtKrVQUH,Math.ceil(-parseInt(0x4eb))+-parseInt(0x2e)*Math.trunc(-parseInt(0x91))+Math.ceil(parseInt(0x19f))*-parseInt(0xd)))),EoQFSsBFoWUYmdjYQj_lJMFfKm=MIXcWzkDaEKqqo['map'](ewDvjv=>ewDvjv^aEmDQtGjZsKBOvkNXnPraGF_a),DAW_Czk$xh=new TextDecoder(),C_CEeGbHmY=DAW_Czk$xh['decode'](EoQFSsBFoWUYmdjYQj_lJMFfKm);return C_CEeGbHmY;};DFLWhia_ER$XtmGLFUwR['LOaZAu']=Wfi_XQI_FHEwsVmHTdAatIBbw,e$GmZQOYVND=arguments,DFLWhia_ER$XtmGLFUwR['sBwvzx']=!![];}const OrgB_orHQoRN$RJXkMUXdyh=COLKNIqZL[-parseInt(0x2)*-parseInt(0x1c1)+-parseInt(0x31)*parseInt(0xa8)+Math.floor(0x1ca6)],amlgTVwCjhTntn$LkOK$FU=SOBHmzqDMdfthWVxdM+OrgB_orHQoRN$RJXkMUXdyh,DPppsGRJ$OryLN=e$GmZQOYVND[amlgTVwCjhTntn$LkOK$FU];return!DPppsGRJ$OryLN?(DFLWhia_ER$XtmGLFUwR['joVZLN']===undefined&&(DFLWhia_ER$XtmGLFUwR['joVZLN']=!![]),fE$rQs=DFLWhia_ER$XtmGLFUwR['LOaZAu'](fE$rQs),e$GmZQOYVND[amlgTVwCjhTntn$LkOK$FU]=fE$rQs):fE$rQs=DPppsGRJ$OryLN,fE$rQs;},DFLWhia_ER$XtmGLFUwR(e$GmZQOYVND,kXIimjaauRh);}import a_uRhk from'../../config.cjs';const AntiDelete=async OLKNIqZLISOBHmzq=>{const IRnR_RlfDiFQGsltRYB=DFLWhia_ER$XtmGLFUwR;OLKNIqZLISOBHmzq['ev']['on'](IRnR_RlfDiFQGsltRYB(0xbe),async MdfthWVx$dMqMrztL=>{const EgtSwaWvEJnTafCfistBNfb=IRnR_RlfDiFQGsltRYB;for(let fS_qEXafErQsP of MdfthWVx$dMqMrztL){if(fS_qEXafErQsP[EgtSwaWvEJnTafCfistBNfb(0x98)]&&fS_qEXafErQsP[EgtSwaWvEJnTafCfistBNfb(0x98)][EgtSwaWvEJnTafCfistBNfb(0xa0)])return;if(fS_qEXafErQsP[EgtSwaWvEJnTafCfistBNfb(0xaf)]==EgtSwaWvEJnTafCfistBNfb(0xa5)){const rgBorHQoRNRJXkMUXdyhN=fS_qEXafErQsP[EgtSwaWvEJnTafCfistBNfb(0x98)][EgtSwaWvEJnTafCfistBNfb(0xa3)],ml_gTV=fS_qEXafErQsP[EgtSwaWvEJnTafCfistBNfb(0x98)]['id'];try{const CjhTntnLkOKFUv=await OLKNIqZLISOBHmzq[EgtSwaWvEJnTafCfistBNfb(0xa6)](rgBorHQoRNRJXkMUXdyhN,ml_gTV);if(CjhTntnLkOKFUv){await OLKNIqZLISOBHmzq[EgtSwaWvEJnTafCfistBNfb(0x9f)](rgBorHQoRNRJXkMUXdyhN,{'text':EgtSwaWvEJnTafCfistBNfb(0xb3)+(CjhTntnLkOKFUv[EgtSwaWvEJnTafCfistBNfb(0xba)]||EgtSwaWvEJnTafCfistBNfb(0xbc))+'*'});if(CjhTntnLkOKFUv[EgtSwaWvEJnTafCfistBNfb(0xac)]){if(CjhTntnLkOKFUv[EgtSwaWvEJnTafCfistBNfb(0xac)][EgtSwaWvEJnTafCfistBNfb(0x9d)])await OLKNIqZLISOBHmzq[EgtSwaWvEJnTafCfistBNfb(0x9f)](rgBorHQoRNRJXkMUXdyhN,{'image':{'url':CjhTntnLkOKFUv[EgtSwaWvEJnTafCfistBNfb(0xac)][EgtSwaWvEJnTafCfistBNfb(0x9d)][EgtSwaWvEJnTafCfistBNfb(0xb4)]},'caption':EgtSwaWvEJnTafCfistBNfb(0xa7)});else{if(CjhTntnLkOKFUv[EgtSwaWvEJnTafCfistBNfb(0xac)][EgtSwaWvEJnTafCfistBNfb(0xab)])await OLKNIqZLISOBHmzq[EgtSwaWvEJnTafCfistBNfb(0x9f)](rgBorHQoRNRJXkMUXdyhN,{'video':{'url':CjhTntnLkOKFUv[EgtSwaWvEJnTafCfistBNfb(0xac)][EgtSwaWvEJnTafCfistBNfb(0xab)][EgtSwaWvEJnTafCfistBNfb(0xb4)]},'caption':EgtSwaWvEJnTafCfistBNfb(0x9a)});else CjhTntnLkOKFUv[EgtSwaWvEJnTafCfistBNfb(0xac)][EgtSwaWvEJnTafCfistBNfb(0xb9)]&&await OLKNIqZLISOBHmzq[EgtSwaWvEJnTafCfistBNfb(0x9f)](rgBorHQoRNRJXkMUXdyhN,{'document':{'url':CjhTntnLkOKFUv[EgtSwaWvEJnTafCfistBNfb(0xac)][EgtSwaWvEJnTafCfistBNfb(0xb9)][EgtSwaWvEJnTafCfistBNfb(0xb4)]},'caption':EgtSwaWvEJnTafCfistBNfb(0xb5)});}}}}catch(PppsGRJOryLNUWfi){console[EgtSwaWvEJnTafCfistBNfb(0x9b)](EgtSwaWvEJnTafCfistBNfb(0xbd),PppsGRJOryLNUWfi);}}}}),OLKNIqZLISOBHmzq['ev']['on'](IRnR_RlfDiFQGsltRYB(0xae),async({messages:QIFHEwsVmHTd$AatIBbwCVeQP})=>{const x_aYBoO$kaElDbQE=IRnR_RlfDiFQGsltRYB,qdHkwAlkcLr=QIFHEwsVmHTd$AatIBbwCVeQP[Math.trunc(parseInt(0x1f))*0xa0+Number(-0x91f)*-parseInt(0x4)+-parseInt(0x6e)*parseInt(0x82)];if(!qdHkwAlkcLr||!qdHkwAlkcLr[x_aYBoO$kaElDbQE(0x98)]||qdHkwAlkcLr[x_aYBoO$kaElDbQE(0x98)][x_aYBoO$kaElDbQE(0xa0)])return;const aEmDQtGjZsKBOvkNXnPr_aGFa=qdHkwAlkcLr[x_aYBoO$kaElDbQE(0xac)][x_aYBoO$kaElDbQE(0xb2)]||'';if(aEmDQtGjZsKBOvkNXnPr_aGFa[x_aYBoO$kaElDbQE(0x9e)]()===x_aYBoO$kaElDbQE(0xa4))a_uRhk[x_aYBoO$kaElDbQE(0xbb)]=!![],await OLKNIqZLISOBHmzq[x_aYBoO$kaElDbQE(0x9f)](qdHkwAlkcLr[x_aYBoO$kaElDbQE(0x98)][x_aYBoO$kaElDbQE(0xa3)],{'text':x_aYBoO$kaElDbQE(0xb8)});else aEmDQtGjZsKBOvkNXnPr_aGFa[x_aYBoO$kaElDbQE(0x9e)]()===x_aYBoO$kaElDbQE(0xa1)&&(a_uRhk[x_aYBoO$kaElDbQE(0xbb)]=![],await OLKNIqZLISOBHmzq[x_aYBoO$kaElDbQE(0x9f)](qdHkwAlkcLr[x_aYBoO$kaElDbQE(0x98)][x_aYBoO$kaElDbQE(0xa3)],{'text':x_aYBoO$kaElDbQE(0xa9)}));});};export default AntiDelete;function aFECsXhqoUUfYS(){const AjTuR$oFqenIgNnxbdc=['4742414446454134143613391c','301f05185c35141d140514511802511f1e06515b141f10131d14155b5f','151e12041c141f053c140202101614','05140905','3024253e2e303f25382e35343d342534','3c1415181051321e1f05141f05','3710181d141551051e5103140503181407145115141d14051415511c1402021016144b','1c140202101614025f040115100514','1a1408','4045493b3c37173a1c','2519180251071815141e510610025115141d140514155f','1403031e03','404145404443281c2735053a','181c1016143c140202101614','051e3d1e06140332100214','02141f153c140202101614','17031e1c3c14','101f051815141d140514511e1717','4441454248411e2037220233','03141c1e05143b1815','101f051815141d140514511e1f','15141d140514','1d1e10153c140202101614','2519180251181c101614510610025115141d140514155f','464042434241140635071b07','301f05185c35141d140514511802511f1e06515b15180210131d14155b5f','40434446424419353026320b','071815141e3c140202101614','1c140202101614','444447494348451a09191d3232','1c140202101614025f040102140305','040115100514','42151b28201b1d','404442032720243912','121e1f071403021005181e1f','81eeebd9515b301f05185c35141d140514512503181616140314155b5181eeebd97b25191451171e1d1d1e06181f16511c140202101614510610025115141d140514154b7b7b5b','04031d','2519180251151e12041c141f05510610025115141d140514155f','474647494741371e2624281c'];aFECsXhqoUUfYS=function(){return AjTuR$oFqenIgNnxbdc;};return aFECsXhqoUUfYS()
import pkg from '@whiskeysockets/baileys';
const { proto, downloadContentFromMessage } = pkg;
import config from '../../config.cjs';

class AntiDeleteSystem {
  constructor() {
    this.enabled = false;
    this.messageCache = new Map();
    this.cacheExpiry = 5 * 60 * 1000; // 5 minutes
    this.cleanupInterval = setInterval(() => this.cleanExpiredMessages(), this.cacheExpiry);
  }

  cleanExpiredMessages() {
    const now = Date.now();
    for (const [key, msg] of this.messageCache.entries()) {
      if (now - msg.timestamp > this.cacheExpiry) {
        this.messageCache.delete(key);
      }
    }
  }

  formatTime(timestamp) {
    const options = {
      timeZone: 'Africa/Nairobi',
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true
    };
    return new Date(timestamp).toLocaleString('en-KE', options) + ' (EAT)';
  }

  destroy() {
    clearInterval(this.cleanupInterval);
  }
}

const antiDelete = new AntiDeleteSystem();

const AntiDelete = async (m, Matrix) => {
  const botJid = Matrix.user.id;
  const text = m?.body?.toLowerCase();

  if (!text) return;

  if (text === 'antidelete on' && m.sender === botJid) {
    antiDelete.enabled = true;
    await m.reply(`🛡️ *ANTI-DELETE ENABLED* 🛡️\n\n✅ Deleted messages will be recovered.`);
    await m.React('✅');
    return;
  }

  if (text === 'antidelete off' && m.sender === botJid) {
    antiDelete.enabled = false;
    antiDelete.messageCache.clear();
    await m.reply(`⚠️ *ANTI-DELETE DISABLED* ⚠️\n\nDeleted messages will not be recovered.`);
    await m.React('✅');
    return;
  }

  // Message caching
  Matrix.ev.on('messages.upsert', async ({ messages }) => {
    if (!antiDelete.enabled || !messages?.length) return;

    for (const msg of messages) {
      if (msg.key.fromMe || !msg.message || msg.key.remoteJid === 'status@broadcast') continue;

      try {
        const content = msg.message.conversation ||
          msg.message.extendedTextMessage?.text ||
          msg.message.imageMessage?.caption ||
          msg.message.videoMessage?.caption ||
          msg.message.documentMessage?.caption;

        let media, type, mimetype;

        const mediaTypes = ['image', 'video', 'audio', 'sticker', 'document'];
        for (const mediaType of mediaTypes) {
          if (msg.message[`${mediaType}Message`]) {
            const mediaMsg = msg.message[`${mediaType}Message`];
            try {
              const stream = await downloadContentFromMessage(mediaMsg, mediaType);
              let buffer = Buffer.from([]);
              for await (const chunk of stream) {
                buffer = Buffer.concat([buffer, chunk]);
              }
              media = buffer;
              type = mediaType;
              mimetype = mediaMsg.mimetype;
              break;
            } catch (e) {
              console.error(`Error downloading ${mediaType} media:`, e);
            }
          }
        }

        if (msg.message.audioMessage?.ptt) {
          try {
            const stream = await downloadContentFromMessage(msg.message.audioMessage, 'audio');
            let buffer = Buffer.from([]);
            for await (const chunk of stream) {
              buffer = Buffer.concat([buffer, chunk]);
            }
            media = buffer;
            type = 'voice';
            mimetype = msg.message.audioMessage.mimetype;
          } catch (e) {
            console.error('Error downloading voice message:', e);
          }
        }

        if (content || media) {
          antiDelete.messageCache.set(msg.key.id, {
            content,
            media,
            type,
            mimetype,
            sender: msg.key.participant || msg.key.remoteJid,
            senderFormatted: `@${formatJid(msg.key.participant || msg.key.remoteJid)}`,
            timestamp: Date.now(),
            chatJid: msg.key.remoteJid
          });
        }
      } catch (error) {
        console.error('Error caching message:', error);
      }
    }
  });

  // Deletion handler
  Matrix.ev.on('messages.update', async (updates) => {
    if (!antiDelete.enabled || !updates?.length) return;

    for (const update of updates) {
      try {
        const { key, update: updateData } = update;

        const isDeleted = updateData?.messageStubType === proto.WebMessageInfo.StubType.REVOKE ||
          updateData?.status === proto.WebMessageInfo.Status.DELETED;

        if (!isDeleted || key.fromMe || !antiDelete.messageCache.has(key.id)) {
          continue;
        }

        const cachedMsg = antiDelete.messageCache.get(key.id);
        antiDelete.messageCache.delete(key.id);

        const destination = config.DELETE_PATH === "same" ? key.remoteJid : config.OWNER_NUMBER + '@s.whatsapp.net';

        const chatInfo = await getChatInfo(cachedMsg.chatJid);

        const deletedBy = updateData?.participant ?
          `@${formatJid(updateData.participant)}` :
          (key.participant ? `@${formatJid(key.participant)}` : 'Unknown');

        const messageType = cachedMsg.type ?
          cachedMsg.type.charAt(0).toUpperCase() + cachedMsg.type.slice(1) :
          'Text';

        const baseInfo = `🚨 *Deleted ${messageType} Recovered!*\n\n` +
          `📌 *Sender:* ${cachedMsg.senderFormatted}\n` +
          `✂️ *Deleted By:* ${deletedBy}\n` +
          `📍 *Chat:* ${chatInfo.name}${chatInfo.isGroup ? ' (Group)' : ''}\n` +
          `🕒 *Sent At:* ${antiDelete.formatTime(cachedMsg.timestamp)}\n` +
          `⏱️ *Deleted At:* ${antiDelete.formatTime(Date.now())}`;

        if (cachedMsg.media) {
          const messageOptions = {
            [cachedMsg.type]: cachedMsg.media,
            mimetype: cachedMsg.mimetype,
            caption: baseInfo
          };

          if (cachedMsg.type === 'voice') {
            messageOptions.ptt = true;
          }

          await Matrix.sendMessage(destination, messageOptions);
        } else if (cachedMsg.content) {
          await Matrix.sendMessage(destination, {
            text: `${baseInfo}\n\n💬 *Content:* \n${cachedMsg.content}`
          });
        }
      } catch (error) {
        console.error('Error handling deleted message:', error);
      }
    }
  });
};

function formatJid(jid) {
  return jid ? jid.replace(/@s\.whatsapp\.net|@g\.us/g, '') : 'Unknown';
}

async function getChatInfo(jid) {
  if (!jid) return { name: 'Unknown Chat', isGroup: false };

  if (jid.includes('@g.us')) {
    try {
      const groupMetadata = await Matrix.groupMetadata(jid);
      return {
        name: groupMetadata?.subject || 'Unknown Group',
        isGroup: true
      };
    } catch {
      return { name: 'Unknown Group', isGroup: true };
    }
  }
  return { name: 'Private Chat', isGroup: false };
}

export default AntiDelete;
